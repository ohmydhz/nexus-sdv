name: Deploy the Nats Bigtable-Connector service

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (sandbox, dev, ...)"
        required: true
      helmAction:
        type: choice
        description: "Sets the action for the helmfile plugin: 'sync' forces an update and 'apply' checks for differences"
        required: false
        default: "sync"
        options:
          - apply
          - sync

  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      helmAction:
        type: string
        description: "Sets the action for the helmfile plugin: 'sync' forces an update and 'apply' checks for differences"
        required: false
        default: "sync"

  push:
    paths:
      - "iac/helm/nats-bigtable-connector"
      - ".github/workflows/deploy-nats-bigtable-connector.yml"
      - "proto/**"

permissions:
  id-token: write
  contents: read

env:
  WORKLOAD_IDENTITY_PROVIDER: "projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ vars.GCP_WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}"
  GKE_CLUSTER_NAME: "${{ inputs.environment }}-gke"

jobs:
  deploy-nats-bigtable-connector:
    name: Deploy NATS BigTable Connector
    runs-on: ${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Google Cloud Auth
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ vars.GCP_WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Import secrets
        uses: google-github-actions/get-secretmanager-secrets@v3
        with:
          secrets: |-
            NATS_BASIC_AUTH_USER:${{ vars.GCP_PROJECT_ID }}/NATS_SERVER_USER
            NATS_BASIC_AUTH_PASSWORD:${{ vars.GCP_PROJECT_ID }}/NATS_SERVER_PASSWORD
            NATS_CONNECTOR_PASSWORD:${{ vars.GCP_PROJECT_ID }}/NATS_CONNECTOR_PASSWORD
            BIGTABLE_CONNECTOR_GCP_SERVICE_ACCOUNT:${{ vars.GCP_PROJECT_ID }}/BIGTABLE_CONNECTOR_GCP_SERVICE_ACCOUNT
            IMAGE_REPO:${{ vars.GCP_PROJECT_ID }}/IMAGE_REPO
          export_to_environment: true

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Configure Kubernetes Context
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} --dns-endpoint --region=${{ vars.GCP_REGION }} --project=${{ vars.GCP_PROJECT_ID }}
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Prepare nats-bigtable-connector proto configmap
        run: |
          mkdir -p iac/helm/nats-bigtable-connector/files
          cp proto/telemetry.proto iac/helm/nats-bigtable-connector/files/

      - name: Deploy nats-bigtable-connector
        uses: helmfile/helmfile-action@v2.0.4
        env:
          GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          BIGTABLE_CONNECTOR_GCP_SERVICE_ACCOUNT: ${{ env.BIGTABLE_CONNECTOR_GCP_SERVICE_ACCOUNT }}
          # NATS URL with embedded connector credentials (read-only access to telemetry.>)
          NATS_URL: "nats://connector:${{ env.NATS_CONNECTOR_PASSWORD }}@nats:4222"
        with:
          helm-version: "v3.19.0"
          helmfile-workdirectory: iac/helm/helmfile.d
          helmfile-args: --file nats-connector.yaml.gotmpl ${{ inputs.helmAction || 'apply' }}
